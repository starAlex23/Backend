<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zeiterfassung</title>
<style>
  /* Basis Styles */
  body {
    font-family: 'Inter', sans-serif;
    margin: 0; padding: 0;
    background: var(--bg, #fff);
    color: var(--fg, #000);
    font-size: 16px;
    line-height: 1.5;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Dark Mode */
  [data-theme="dark"] {
    --bg: #121212;
    --fg: #eee;
    --card-bg: #222;
  }

  header {
    background: #4CAF50;
    color: white;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 1.2rem;
    position: sticky;
    top: 0;
    z-index: 1100;
  }

  main {
    flex-grow: 1;
    max-width: 100%;
    margin: 0 auto;
    padding: 1rem;
    box-sizing: border-box;
    min-height: calc(100vh - 160px); /* Header + Bottom Nav */
  }

  /* Karten-Style f√ºr Bereiche */
  .card {
    background: var(--card-bg, #f9f9f9);
    padding: 1.5rem 1.8rem;
    margin-bottom: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
  }

  /* Verstecken */
  .hidden {
    display: none !important;
  }

  /* Allgemeine Views innerhalb Auth oder App */
  .view {
    max-width: 400px;
    margin: 0 auto 4rem auto;
  }

  /* Inputs */
  label {
    display: block;
    margin-top: 1rem;
    font-weight: 500;
  }

  input[type="email"],
  input[type="password"],
  input[type="text"] {
    width: 100%;
    padding: 0.8rem;
    margin-top: 0.4rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
    box-sizing: border-box;
  }

  /* Buttons */
  button {
    display: block;
    width: 100%;
    margin-top: 1.2rem;
    padding: 0.9rem;
    font-size: 1.05rem;
    border-radius: 6px;
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  button:hover:not(:disabled) {
    background: #45a049;
  }

  button:disabled {
    background: #999;
    cursor: not-allowed;
  }

  /* Link-Style f√ºr Buttons die wie Links aussehen */
  .link {
    text-align: center;
    margin-top: 1rem;
  }

  .link button {
    background: none;
    border: none;
    color: #4CAF50;
    text-decoration: underline;
    font-size: 1rem;
    padding: 0.4rem;
    cursor: pointer;
  }

  /* Bottom Navigation */
/* Bottom Navigation - modernisiert */
#bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background: white;
  border-top: 1px solid #ccc;
  padding: 0.6rem 0;
  box-shadow: 0 -1px 6px rgba(0, 0, 0, 0.05);
  z-index: 1000;
}

#bottom-nav button {
  background: none;
  border: none;
  font-size: 1.6rem;
  color: #888;
  padding: 0.5rem;
  cursor: pointer;
  transition: color 0.2s ease, transform 0.2s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#bottom-nav button:hover {
  color: #4CAF50;
  transform: translateY(-2px);
}

#bottom-nav button svg {
  width: 24px;
  height: 24px;
}

/* Aktiver Button */
#bottom-nav .active {
  color: #4CAF50;
}

/* Kamera-Button (zentral) */
#bottom-nav .main-button {
  background: linear-gradient(to right, #43cea2, #185a9d);
  color: white !important;
  font-size: 2rem;
  border-radius: 50%;
  padding: 0.8rem;
  margin-top: -1.5rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  transition: transform 0.2s ease;
  position: relative;
}

#bottom-nav .main-button:hover {
  transform: scale(1.1);
}

/* Mobile Optimierung */
@media (max-width: 480px) {
  #bottom-nav {
    font-size: 1.3rem;
  }

  #bottom-nav button svg {
    width: 20px;
    height: 20px;
  }

  #bottom-nav .main-button {
    font-size: 1.8rem;
    padding: 0.7rem;
  }
}
  /* Auth Container (Login & Reset) */
  #auth-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    min-height: calc(100vh - 160px);
  }

  /* Sections innerhalb Auth Container */
  #auth-container section.view {
    background: var(--card-bg, #f9f9f9);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
    transition: opacity 0.3s ease;
    width: 100%;
    max-width: 400px;
  }

  /* App View Container */
  #app-view {
    flex-grow: 1;
    padding: 1rem;
    min-height: calc(100vh - 160px);
    overflow-y: auto;
  }

  /* Passwort Fehler-Meldung */
  .password-error {
    color: #e74c3c; /* dunkles rot */
    font-size: 0.85rem;
    margin-top: 0.3rem;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
  }

  /* Kleinere Ger√§te */
  @media (max-width: 360px) {
    header h1 {
      font-size: 1.1rem;
    }
    button {
      font-size: 0.95rem;
      padding: 0.75rem;
    }
    label,
    input {
      font-size: 0.95rem;
    }
  }
</style>
</head>
<body data-theme="light">
<header role="banner" style="position: sticky; top: 0; z-index: 1100;">
  <h1 style="flex-grow:1;">Zeiterfassung</h1>
</header>

<main role="main" aria-live="polite">

  <!-- Auth Container: Login, Registrierung, Passwort vergessen -->
  <div id="auth-container" aria-live="polite">
    <section id="login-view" class="view">
      <h2>Login</h2>
      <form id="login-form">
        <input name="email" type="email" required autocomplete="email" placeholder="E-Mail" />
        <input name="passwort" type="password" required autocomplete="current-password" placeholder="Passwort" />
        <button type="submit">Einloggen</button>
      </form>
      <p style="margin-top: 10px; text-align: center;">
        <a href="#" id="forgot-password-link">Passwort vergessen?</a>
      </p>
      <p id="verifyWarning" class="hidden" style="color: red; margin-top: 10px; text-align: center;">
        Deine E-Mail ist noch nicht verifiziert. <br />
        <button id="resendBtn" type="button" disabled>Code erneut senden</button>
      </p>
      <button id="show-register-btn" class="link" type="button">Noch kein Konto?</button>
    </section>

    <section id="reset-request-view" class="view hidden" aria-label="Passwort zur√ºcksetzen - Schritt 1">
      <h2>Passwort zur√ºcksetzen</h2>
      <form id="reset-request-form">
        <input name="email" type="email" required placeholder="E-Mail" autocomplete="email" />
        <input name="vorname" type="text" required placeholder="Vorname" />
        <input name="nachname" type="text" required placeholder="Nachname" />
        <button type="submit">Code anfordern</button>
      </form>
      <button id="back-to-login-from-request" class="link" type="button">Zur√ºck zum Login</button>
    </section>

    <section id="reset-verify-view" class="view hidden" aria-label="Passwort zur√ºcksetzen - Schritt 2">
      <h2>Code eingeben und neues Passwort setzen</h2>
      <form id="reset-verify-form">
        <input name="email" type="email" required placeholder="E-Mail" autocomplete="email" />
        <input name="code" type="text" required placeholder="Best√§tigungscode" />
        <input name="neuesPasswort" type="password" required placeholder="Neues Passwort" />
        <button type="submit">Passwort √§ndern</button>
      </form>
      <button id="back-to-login-from-verify" class="link" type="button">Zur√ºck zum Login</button>
    </section>

    <section id="register-view" class="view hidden" aria-label="Registrierung">
      <h2>Registrieren</h2>
      <form id="register-form">
        <input name="firstname" placeholder="Vorname" required />
        <input name="lastname" placeholder="Nachname" required />
        <input name="email" placeholder="E-Mail" type="email" required />
        <input name="passwort" placeholder="Passwort" type="password" required />
        <button type="submit">Registrieren</button>
      </form>
      <button id="show-login-btn" class="link" type="button">Zur√ºck zum Login</button>
    </section>
  </div>

  <!-- App-Ansicht nach Login -->
  <div id="app-view" class="hidden" aria-live="polite" tabindex="-1">
    <!-- Bottom Navigation -->
   <nav id="bottom-nav" aria-label="Hauptnavigation">
  <button data-target="mein-tag-section" aria-label="Mein Tag">
    <i data-lucide="calendar-days"></i>
  </button>
  <button data-target="arbeitsplanung-section" aria-label="Arbeitsplanung">
    <i data-lucide="clipboard-list"></i>
  </button>
  <button data-target="zeiterfassung-section" aria-label="Zeiterfassung" class="main-button">
    <i data-lucide="camera"></i>
  </button>
  <button data-target="chat-section" aria-label="Chat">
    <i data-lucide="message-circle"></i>
  </button>
  <button data-target="settings-section" aria-label="Einstellungen">
    <i data-lucide="settings"></i>
  </button>
</nav>

    <!-- QR-Gate vor der Zeiterfassung -->
    <section id="qr-section" class="card view hidden" aria-label="QR-Scan Gate">
      <h2>QR-Code scannen</h2>
      <div id="qr-reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
      <p>Bitte scanne deinen QR-Code, um zur Zeiterfassung zu gelangen.</p>
    </section>

    <!-- 1. Mein Tag -->
    <section id="mein-tag-section" class="card view" aria-label="Mein Tag">
      <h2>Mein Tag</h2>
      <p>Hier siehst du deinen heutigen Einsatz.</p>
      <div class="user-info">
        Angemeldet als: <span id="user-name">‚Ä¶</span>
      </div>
    </section>

    <!-- 2. Arbeitsplanung -->
    <section id="arbeitsplanung-section" class="card view hidden" aria-label="Arbeitsplanung">
      <h2>Arbeitsplanung</h2>
      <p>(Hier kommt sp√§ter die Einsatzplanung hin)</p>
    </section>

    <!-- 3. Zeiterfassung (inkl. QR-Scanner und ggf. QR-Generator f√ºr Vorarbeiter) -->
    <section id="zeiterfassung-section" class="card view hidden" aria-label="Zeiterfassung">
      <h2>Zeiterfassung</h2>

      <button id="clock-in-btn" type="button">Einstempeln (Start)</button>
      <button id="clock-out-btn" type="button" disabled>Ausstempeln (Stop)</button>

      <p id="time-message"></p>

      <!-- QR-Code Generator (nur sichtbar f√ºr Vorarbeiter) -->
      <div id="qr-generator-container" class="hidden" style="margin-top: 2rem;">
        <h3>QR-Code f√ºr Arbeiter</h3>
        <button id="generate-qr-btn" type="button">QR-Code generieren (15 Min g√ºltig)</button>
        <div id="qr-container" style="margin-top: 1rem;"></div>
        <p id="qr-valid-until" style="font-size: 0.9rem; color: #555;"></p>
      </div>

      <button id="logout-btn" type="button" style="margin-top:2rem; background:#e74c3c; color:#fff;">
        Ausloggen
      </button>
    </section>

    <!-- 4. Chat -->
    <section id="chat-section" class="card view hidden" aria-label="Chat">
      <h2>Chat</h2>
      <p>Kommunikation mit Vorarbeitern und Verwaltung</p>
    </section>

    <!-- 5. Einstellungen -->
    <section id="settings-section" class="card view hidden" aria-label="Einstellungen">
      <h2>Einstellungen</h2>
      <label for="darkmode-switch-main">
        <input type="checkbox" id="darkmode-switch-main" />
        Dark Mode
      </label>
    </section>
  </div>
</main>
<!-- QR-Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>
<!-- QR-Code-Generator Bibliothek -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<!-- Bibiothek f√ºr navbar icons --> 
<script src="https://unpkg.com/lucide@latest"></script>
<script type="module">
  import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm";

 document.addEventListener('DOMContentLoaded', () => {
  const generateBtn = document.getElementById('generate-qr-btn');
  const qrContainer = document.getElementById('qr-container');
  const qrValidUntil = document.getElementById('qr-valid-until');

  if (!generateBtn || !qrContainer || !qrValidUntil) {
    console.warn('‚ö†Ô∏è QR-Code-UI-Element(e) fehlen: Button, Container oder G√ºltigkeitsanzeige nicht gefunden.');
    return;
  }

  generateBtn.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/qr/create', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': csrfToken,
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });

      if (!res.ok) {
        console.error('‚ùå QR-Code konnte nicht generiert werden ‚Äì Serverfehler:', res.status);
        alert('Fehler beim QR-Code-Generieren');
        return;
      }

      const { qrToken, g√ºltigBis } = await res.json();
      const cleanToken = qrToken.trim();
      console.log('‚ñ∂Ô∏è QR-Inhalt:', cleanToken);

      const canvas = document.createElement('canvas');
      await QRCode.toCanvas(canvas, cleanToken, {
        width: 256,
        margin: 1,
        color: {
          dark: '#000000',
          light: '#ffffff',
        },
        errorCorrectionLevel: 'M'
      });

      qrContainer.innerHTML = '';
      qrContainer.appendChild(canvas);

      const validUntil = new Date(g√ºltigBis).toLocaleTimeString();
      qrValidUntil.textContent = `G√ºltig bis: ${validUntil}`;
    } catch (err) {
      console.error('‚ùå Fehler beim Erzeugen des QR-Codes:', err);
      alert('Fehler beim Abrufen des QR-Codes.');
    }
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const darkmodeSwitch = document.getElementById('darkmode-switch-main');
  if (!darkmodeSwitch) {
    console.warn('‚ö†Ô∏è Darkmode-Switch #darkmode-switch-main nicht gefunden.');
    return;
  }

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    darkmodeSwitch.checked = theme === 'dark';
  }

  // Gespeicherten Wert oder Systemvoreinstellung laden
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    setTheme(savedTheme);
  } else {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }

  // Umschalten
  darkmodeSwitch.addEventListener('change', () => {
    setTheme(darkmodeSwitch.checked ? 'dark' : 'light');
  });
});

// Zeitstatus pr√ºfen
document.addEventListener('DOMContentLoaded', async () => {
  const token = sessionStorage.getItem('accessToken');
  if (!token) {
    console.warn('‚õî Kein accessToken in sessionStorage ‚Äì Statuspr√ºfung √ºbersprungen.');
    return;
  }

  try {
    const status = await getLetzterStatus();

    const clockInBtn = document.getElementById('clock-in-btn');
    const clockOutBtn = document.getElementById('clock-out-btn');

    if (!clockInBtn || !clockOutBtn) {
      console.warn('‚ö†Ô∏è Clock-In oder Clock-Out Button nicht im DOM gefunden.');
      return;
    }

    const eingestempelt = status?.eingestempelt;

    if (eingestempelt === true) {
      clockInBtn.disabled = true;
      clockOutBtn.disabled = false;
    } else if (eingestempelt === false) {
      clockInBtn.disabled = false;
      clockOutBtn.disabled = true;
    } else {
      console.warn('‚ö†Ô∏è Ung√ºltiger Statuswert:', eingestempelt);
      clockInBtn.disabled = false;
      clockOutBtn.disabled = false;
    }
  } catch (err) {
    console.error('‚ùå Fehler beim Abrufen des letzten Zeitstatus:', err);
  }
});

lucide.createIcons();
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Alles zum passwort zur√ºcksetzen
  
const authContainer = document.getElementById('auth-container');

const views = {
  login: document.getElementById('login-view'),
  resetRequest: document.getElementById('reset-request-view'),
  resetVerify: document.getElementById('reset-verify-view'),
};

function showView(viewName) {
  Object.values(views).forEach(view => view.classList.add('hidden'));
  views[viewName].classList.remove('hidden');
}

// Login ‚Üí Passwort vergessen Link √∂ffnet resetRequest
document.getElementById('forgot-password-link').addEventListener('click', e => {
  e.preventDefault();
  // Login-E-Mail im Reset-Form vorausf√ºllen (optional)
  const loginEmail = views.login.querySelector('input[name="email"]').value;
  views.resetRequest.querySelector('input[name="email"]').value = loginEmail || '';
  showView('resetRequest');
});

// Zur√ºck-Buttons
document.getElementById('back-to-login-from-request').addEventListener('click', () => showView('login'));
document.getElementById('back-to-login-from-verify').addEventListener('click', () => showView('login'));

// Hilfsfunktion zur Passwortvalidierung
function isValidPassword(pwd) {
  return (
    typeof pwd === 'string' &&
    pwd.length >= 8 &&
    /[A-Z]/.test(pwd) &&
    /[0-9]/.test(pwd) &&
    /[!@#$%^&*(),.?":{}|<>_\-\\\/\[\];'`~+=]/.test(pwd)
  );
}

// Optional: Fehlermeldung unter Passwortfeld anzeigen / entfernen
function showPasswordError(input, message) {
  let errorEl = input.nextElementSibling;
  if (!errorEl || !errorEl.classList.contains('password-error')) {
    errorEl = document.createElement('div');
    errorEl.className = 'password-error';
    errorEl.style.color = 'red';
    errorEl.style.fontSize = '0.9rem';
    errorEl.style.marginTop = '0.3rem';
    input.parentNode.insertBefore(errorEl, input.nextSibling);
  }
  errorEl.textContent = message;
}

// Live-Validierung f√ºr Passwort im Reset-Verify-Form
const resetPasswordInput = views.resetVerify.querySelector('input[name="neuesPasswort"]');
if (resetPasswordInput) {
  resetPasswordInput.setAttribute('autocomplete', 'new-password');
  resetPasswordInput.addEventListener('input', () => {
    if (resetPasswordInput.value === '') {
      showPasswordError(resetPasswordInput, '');
    } else if (!isValidPassword(resetPasswordInput.value)) {
      showPasswordError(
        resetPasswordInput,
        'Passwort muss mindestens 8 Zeichen, 1 Gro√übuchstabe, 1 Zahl & 1 Sonderzeichen enthalten.'
      );
    } else {
      showPasswordError(resetPasswordInput, '');
    }
  });
}

// Passwort zur√ºcksetzen - Schritt 1: Code anfordern
document.getElementById('reset-request-form').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const data = {
    email: form.email.value.trim(),
    vorname: form.vorname.value.trim(),
    nachname: form.nachname.value.trim(),
  };

  try {
    const res = await fetch('/api/reset-request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    const json = await res.json();

    if (!res.ok) throw new Error(json.error || 'Fehler beim Anfordern des Codes');

    // Email auch im Verifizierungsformular vorausf√ºllen
    views.resetVerify.querySelector('input[name="email"]').value = data.email;

    alert('Code wurde verschickt. Bitte √ºberpr√ºfe deine E-Mails.');
    showView('resetVerify');
  } catch (err) {
    alert(err.message);
  }
});

// Passwort zur√ºcksetzen - Schritt 2: Code pr√ºfen + Passwort √§ndern
document.getElementById('reset-verify-form').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;

  const neuesPasswort = form.neuesPasswort.value.trim();

  // Passwort validieren vor dem Absenden
  if (!isValidPassword(neuesPasswort)) {
    alert('Passwort muss mindestens 8 Zeichen lang sein und mindestens einen Gro√übuchstaben, eine Zahl und ein Sonderzeichen enthalten.');
    form.neuesPasswort.focus();
    return;
  }

  const verifyData = {
    email: form.email.value.trim(),
    code: form.code.value.trim(),
  };

  try {
    // Code validieren + resetToken erhalten
    let res = await fetch('/api/reset-verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(verifyData),
    });
    let json = await res.json();

    if (!res.ok) throw new Error(json.error || 'Code ung√ºltig');

    const resetToken = json.resetToken;

    // Neues Passwort setzen
    res = await fetch('/api/reset-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        resetToken,
        neuesPasswort,
      }),
    });
    json = await res.json();

    if (!res.ok) throw new Error(json.error || 'Fehler beim Passwort setzen');

    alert('Passwort erfolgreich ge√§ndert. Bitte logge dich neu ein.');
    showView('login');
  } catch (err) {
    alert(err.message);
  }
});
  
// API-Konstanten
const BASE = '/api';
const API_BASE = '/api';
const API_BASE_URL = '';
  
// DOM-Elemente
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterBtn = document.getElementById('show-register-btn');
const showLoginBtn = document.getElementById('show-login-btn');
const logoutBtn = document.getElementById('logout-btn');
const userNameSpan = document.getElementById('user-name');
const clockInBtn = document.getElementById('clock-in-btn');
const clockOutBtn = document.getElementById('clock-out-btn');
const qrSection = document.getElementById('qr-section');
const navButtons = Array.from(document.querySelectorAll('#bottom-nav button'));
const zeiterfassungSection = document.getElementById("zeiterfassung-section");
const meinTagSection = document.getElementById("mein-tag-section");
const arbeitsplanungSection = document.getElementById("arbeitsplanung-section");
const chatSection = document.getElementById("chat-section");
const settingsSection = document.getElementById("settings-section");
const verifyWarning = document.getElementById('verifyWarning');
const resendBtn = document.getElementById('resendBtn');

// Navbar Button (gro√üer Zeiterfassungsbutton)
const zeiterfassungBtn = document.querySelector('button.main-button[data-target="zeiterfassung-section"]');

// Settings (Dropdown oben rechts)
const darkModeSwitch = document.getElementById('darkmode-switch-main');

// Bereiche / Views
const qrGeneratorSection = document.getElementById('qr-generator-container'); // QR-Code Generator
const loginSection = document.getElementById('login-view');
const registerSection = document.getElementById('register-view');

const qrReaderElem = document.getElementById('qr-reader');
const qrMessage = document.getElementById('qr-message');

const loginEmail = document.getElementById('login-email');
const loginPassword = document.getElementById('login-password');
const loginError = document.getElementById('login-error');

// Session-Zustand
let csrfToken = localStorage.getItem('csrfToken') || '';
let loggedInUser = null;

// Globale Rolle merken (wird beim Login gesetzt)
let isVorarbeiterGlobal = false; 

// Statusvariablen
let scannerIsRunning = false;
let html5QrCode = null;
let qrScanErfolgt = false;
  
// Hilfsfunktion: Cookie auslesen
function getCookie(name) {
  const cookies = document.cookie.split(';').map(c => c.trim());
  for (const cookie of cookies) {
    if (cookie.startsWith(name + '=')) {
      return decodeURIComponent(cookie.substring(name.length + 1));
    }
  }
  return null;
}

  // QR-Code validieren (API-Aufruf)
  async function validateQrCode(qr) {
    const csrfToken = localStorage.getItem("csrfToken");
    const res = await fetch(`${API_BASE}/validate-qr`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": csrfToken,
      },
      credentials: "include",
      body: JSON.stringify({ qr }),
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || "Ung√ºltiger QR-Code");
    }
    return await res.json();
  }

  // QR-Code wurde erkannt und validiert
  async function onQrCodeDetected(decodedText) {
    try {
      console.log("‚û°Ô∏è QR-Code erkannt:", decodedText);
      await validateQrCode(decodedText);
      console.log("‚úÖ QR-Code g√ºltig ‚Äì Zeiterfassung wird ge√∂ffnet.");
      qrScanErfolgt = true;
      await hideQrGate();
      showSection(zeiterfassungSection);
    } catch (err) {
      console.warn("‚õî QR ung√ºltig:", err.message);
      alert("Ung√ºltiger QR-Code: " + err.message);
      await startQrScanner();
    }
  }
  
// QR-Gate anzeigen und Scanner starten
async function showQrGate() {
  if (isVorarbeiterGlobal) return; // Schutzregel
  if (!qrSection) return;
  qrSection.classList.remove("hidden");
  qrSection.setAttribute("aria-hidden", "false");
  await startQrScanner();
}

// QR-Gate verstecken und Scanner stoppen
async function hideQrGate() {
    if (!qrSection) return;
    qrSection.classList.add("hidden");
    qrSection.setAttribute("aria-hidden", "true");
    await stopQrScanner();
  }

 // QR Scanner starten
 async function startQrScanner() {
  if (html5QrCode) {
    console.log("üì∑ Scanner l√§uft schon, Start √ºbersprungen");
    return;
  }

  if (isVorarbeiterGlobal) {
    console.log("üë∑ Vorarbeiter - QR-Scanner wird nicht gestartet.");
    qrScanErfolgt = true; // Gate √ºberspringen
    return;
  }

  const qrReaderElement = document.getElementById('qr-reader');
  if (!qrReaderElement) {
    console.error("‚ùå #qr-reader nicht gefunden!");
    return;
  }

  html5QrCode = new Html5Qrcode("qr-reader");

  try {
    await html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.333,
      },
      async (decodedText, decodedResult) => {
        if (qrScanErfolgt) return;
        qrScanErfolgt = true;

        console.log("‚úÖ QR-Code erkannt:", decodedText);

        await onQrCodeDetected(decodedText);

        await stopQrScanner();
      },
      (errorMessage) => {
        // Fehler ignorieren, wenn keine Codes gefunden
      }
    );
  } catch (err) {
    console.error("Fehler beim Starten des QR-Scanners:", err);
  }
}

  // QR Scanner stoppen
  async function stopQrScanner() {
    if (html5QrCode) {
      try {
        await html5QrCode.stop();
        html5QrCode.clear();
      } catch (err) {
        console.error("‚ùå Fehler beim Stoppen des Scanners:", err);
      } finally {
        html5QrCode = null;
      }
    }
    qrScanErfolgt = false;
  }
  
// Haupt-Fetch mit automatischem Token-Refresh, CSRF-Token und Auth-Header
async function apiFetch(path, options = {}) {
  const method = (options.method || 'GET').toUpperCase();
  const writeMethods = ['POST', 'PUT', 'DELETE', 'PATCH'];

  options = { ...options };
  options.headers = options.headers || {};
  options.credentials = 'include'; // wichtig f√ºr Cookies

  // CSRF-Header bei schreibenden Requests
  if (writeMethods.includes(method)) {
    if (!options.headers['Content-Type']) {
      options.headers['Content-Type'] = 'application/json';
    }

    if (csrfToken) {
      options.headers['X-CSRF-Token'] = csrfToken;
    } else {
      console.warn('‚ö†Ô∏è Kein CSRF-Token vorhanden.');
    }
  }

  const url = path.startsWith('http') ? path : (API_BASE_URL + path);

  const fetchWithCookies = () => fetch(url, options);

  let response = await fetchWithCookies();

  // Falls AccessToken abgelaufen ‚Üí versuche Refresh
  if (response.status === 401) {
    const refreshRes = await fetch(`${API_BASE_URL}/api/refresh`, {
      method: 'POST',
      credentials: 'include',
    });

    if (!refreshRes.ok) {
      throw new Error('Login abgelaufen. Bitte neu einloggen.');
    }

    // Neuen CSRF-Token √ºbernehmen (optional)
    const data = await refreshRes.json().catch(() => null);
    if (data?.csrfToken) {
      csrfToken = data.csrfToken;
      localStorage.setItem('csrfToken', csrfToken);
    }

    // Wiederhole urspr√ºnglichen Request
    response = await fetchWithCookies();

    if (response.status === 401) {
      throw new Error('Token-Refresh gescheitert. Bitte neu einloggen.');
    }
  }

  if (!response.ok) {
  let code = 'HTTP_ERROR';
  let message = `Fehler: HTTP ${response.status}`;
  try {
    const err = await response.json();
    code = err?.code || code;
    message = err?.error || err?.message || message;
  } catch {}

  throw { code, message };
}

  try {
    return await response.json();
  } catch {
    return {};
  }
}
  
// Login-Funktion: speichert Access- und CSRF-Token
async function login(email, passwort) {
  if (!email || !passwort) {
    throw { code: 'MISSING_FIELDS', message: 'Bitte Email und Passwort ausf√ºllen!' };
  }

  try {
    const res = await apiFetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, passwort }),
    });

    if (!res.user) {
      throw { code: 'NO_USER', message: 'Login erfolgreich, aber kein Benutzerobjekt erhalten.' };
    }

    console.log('‚úÖ Eingeloggt:', res.user);

    if (res.csrfToken) {
      localStorage.setItem('csrfToken', res.csrfToken);
      csrfToken = res.csrfToken;
    }

    loggedInUser = res.user;

    isVorarbeiterGlobal = res.user.rolle === 'vorarbeiter';
    if (isVorarbeiterGlobal) {
      console.log('Vorarbeiter eingeloggt ‚Üí QR-Skip aktiv');
    }

    await updateUIAfterLogin(res.user);

  } catch (err) {
    if (err?.code === 'EMAIL_NOT_VERIFIED') {
      throw err; // gezielt weiterreichen
    }

    const message = err?.message || 'Unbekannter Fehler beim Login.';
    throw { code: 'LOGIN_FAILED', message };
  }
}

loginForm.addEventListener('submit', async (event) => {
  event.preventDefault();

  const email = loginForm.email.value.trim();
  const passwort = loginForm.passwort.value;

  // Hinweis ausblenden und Button deaktivieren
  verifyWarning.classList.add('hidden');
  resendBtn.disabled = true;
  resendBtn.dataset.email = '';

  try {
    // login() ist deine bestehende Login-Funktion, die Fehler wirft
    await login(email, passwort);
  } catch (err) {
    console.error('Login fehlgeschlagen:', err);

    // Pr√ºfe, ob Fehler vom Backend wegen nicht verifizierter E-Mail kommt
    if (err.code === 'LOGIN_FAILED' && err.message.includes('E-Mail')) {
      // Zeige Warnung
      verifyWarning.classList.remove('hidden');

      // Button aktivieren und E-Mail speichern
      resendBtn.disabled = false;
      resendBtn.dataset.email = email;
    } else {
      alert(err.message || 'Unbekannter Fehler beim Login.');
    }
  }
});

// Klick auf "Code erneut senden"
resendBtn.addEventListener('click', async () => {
  const email = resendBtn.dataset.email;
  if (!email) return;

  resendBtn.disabled = true;
  resendBtn.textContent = 'Sende...';

  try {
    const res = await apiFetch('/api/resend-verification', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email }),
    });

    if (res.success) {
      resendBtn.textContent = 'Code gesendet!';
      setTimeout(() => {
        resendBtn.textContent = 'Code erneut senden';
        resendBtn.disabled = false;
      }, 15000); // 15 Sekunden Sperre
    } else {
      alert(res.message || 'Fehler beim Senden');
      resendBtn.disabled = false;
      resendBtn.textContent = 'Code erneut senden';
    }
  } catch (err) {
    console.error('Fehler beim erneuten Senden:', err);
    alert('Netzwerkfehler beim Senden.');
    resendBtn.disabled = false;
    resendBtn.textContent = 'Code erneut senden';
  }
});
  
async function updateProfile() {
  try {
    const user = await apiFetch('/api/me', {}, true);  // optional: mit Authorization
    loggedInUser = user;
   
    updateUIAfterLogin(user); // ‚¨ÖÔ∏è hier √úbergabe fixen!
  } catch (err) {
    console.error('Profil konnte nicht geladen werden:', err);
    handleLogoutCleanup();
  }
}
  
// === Sections anzeigen ===
function showSection(section) {
  if (!section) {
    console.error("‚ùå showSection: √úbergabe-Section ist null oder undefiniert!");
    return;
  }

  // Falls String √ºbergeben wurde ‚Üí DOM-Element holen
  if (typeof section === 'string') {
    const el = document.getElementById(section);
    if (!el) {
      console.error("‚ùå showSection: Kein Element gefunden mit ID:", section);
      return;
    }
    section = el;
  }

  // Alle ".view"-Sektionen im #app-view ausblenden
  const appView = document.getElementById('app-view');
  if (appView) {
    appView.querySelectorAll('.view').forEach(sec => {
      sec.classList.add('hidden');
      sec.setAttribute('aria-hidden', 'true');
    });
  }

  // Gew√ºnschte Section anzeigen
  section.classList.remove('hidden');
  section.setAttribute('aria-hidden', 'false');
}

 function showPopupMessage(msg, duration = 3000) {
  const popup = document.getElementById('popup-message');
  popup.textContent = msg;
  popup.classList.remove('hidden');

  setTimeout(() => {
    popup.classList.add('hidden');
  }, duration);
}

// === Helper Funktionen zur Base64-URL-Konvertierung (f√ºr WebAuthn) ===
function base64urlToUint8Array(base64urlString) {
  const padding = '='.repeat((4 - (base64urlString.length % 4)) % 4);
  const base64 = (base64urlString + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

function toBase64Url(buffer) {
  const bytes = new Uint8Array(buffer);
  let str = '';
  for (let i = 0; i < bytes.byteLength; i++) {
    str += String.fromCharCode(bytes[i]);
  }
  return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// === UI Aktualisierung nach Login ===
async function updateUIAfterLogin(user) {
  console.log("üîê updateUIAfterLogin aufgerufen:", user);

  if (!user) {
    console.warn('‚ö†Ô∏è Kein Benutzerobjekt √ºbergeben an updateUIAfterLogin');
    return;
  }

  loggedInUser = user;
  isVorarbeiterGlobal = user.rolle === 'vorarbeiter';
  qrScanErfolgt = isVorarbeiterGlobal; // Vorarbeiter brauchen kein QR-Gate

  // Benutzername anzeigen
  const nameEl = document.getElementById('user-name');
  if (nameEl) {
    nameEl.textContent = user.name || user.email || 'Benutzer';
  }

  // Auth-Container ausblenden
  const authContainer = document.getElementById('auth-container');
  if (authContainer) {
    authContainer.classList.add('hidden');
    authContainer.setAttribute('aria-hidden', 'true');
  }

  // App-Ansicht anzeigen
  const appView = document.getElementById('app-view');
  if (appView) {
    appView.classList.remove('hidden');
    appView.setAttribute('aria-hidden', 'false');
  }

  // QR-Generator (nur f√ºr Vorarbeiter)
  const qrGen = document.getElementById('qr-generator-container');
  if (qrGen) {
    qrGen.classList.toggle('hidden', !isVorarbeiterGlobal);
    qrGen.setAttribute('aria-hidden', String(!isVorarbeiterGlobal));
  }

  // QR-Reader (nur f√ºr normale Nutzer)
  const qrReader = document.getElementById('qr-reader');
  if (qrReader) {
    qrReader.classList.toggle('hidden', isVorarbeiterGlobal);
    qrReader.setAttribute('aria-hidden', String(isVorarbeiterGlobal));
  }

  // QR-Section ggf. entfernen (f√ºr Vorarbeiter)
  const qrSection = document.getElementById('qr-section');
  if (isVorarbeiterGlobal && qrSection) {
    qrSection.remove();
  }

  // Navigation & Logout anzeigen
  if (logoutBtn) logoutBtn.classList.remove('hidden');
  const bottomNav = document.getElementById('bottom-nav');
  if (bottomNav) bottomNav.classList.remove('hidden');

  // === QR-Logik & Sichtbare Section ===
  if (isVorarbeiterGlobal || qrScanErfolgt) {
    await hideQrGate();
    showSection('zeiterfassung-section');
  } else {
    await showQrGate();
    showSection('qr-section');
  }

  // === Aktuellen Zeitstatus vom Server holen ===
  try {
    const status = await apiFetch('/api/zeit/letzter-status');
    const eingestempelt = status.eingestempelt;
    const letzteAktion = status.letzteAktion; // z.B. 'start', 'stop', 'pause'

    const timeMessage = document.getElementById('time-message');

    if (eingestempelt) {
      console.log("‚úÖ Bereits eingestempelt (letzte Aktion):", letzteAktion);
      if (clockInBtn) clockInBtn.disabled = true;
      if (clockOutBtn) clockOutBtn.disabled = false;
      if (timeMessage) {
        timeMessage.textContent = `Du bist aktuell eingestempelt (letzte Aktion: ${letzteAktion}).`;
      }
    } else {
      console.log("üïí Noch nicht eingestempelt.");
      if (clockInBtn) clockInBtn.disabled = false;
      if (clockOutBtn) clockOutBtn.disabled = true;
      if (timeMessage) {
        timeMessage.textContent = "Noch nicht eingestempelt.";
      }
    }
  } catch (err) {
    console.error("‚ùå Fehler beim Laden des Zeitstatus:", err);
    const timeMessage = document.getElementById('time-message');
    if (timeMessage) timeMessage.textContent = "Fehler beim Laden des Zeitstatus.";
  }
}

// === Logout Cleanup ===
function handleLogoutCleanup() {
  loggedInUser = null;

  const loginForm = document.getElementById('login-form');
  if (loginForm) {
    if (loginForm['email']) loginForm['email'].value = '';
    if (loginForm['passwort']) loginForm['passwort'].value = '';
  }

  // Tokens aus Speicher l√∂schen
  sessionStorage.removeItem('accessToken');
  localStorage.removeItem('csrfToken');
  document.cookie = 'csrfToken=; Max-Age=0; path=/; secure; SameSite=None';

  // Alle Haupt-Sections ausblenden, au√üer Login-View
  [
    document.getElementById('qr-section'),
    document.getElementById('register-view'),
    document.getElementById('time-tracking-section'),
    document.getElementById('mein-tag-section'),
    document.getElementById('arbeitsplanung-section'),
    document.getElementById('zeiterfassung-section'),
    document.getElementById('chat-section'),
    document.getElementById('settings-section'),
    document.getElementById('qr-generator-section')
  ].filter(Boolean).forEach(sec => {
    if (sec.id !== 'login-view') {
      sec.classList.add('hidden');
      sec.setAttribute('aria-hidden', 'true');
    }
  });

  // Login-View anzeigen
  const loginView = document.getElementById('login-view');
  if (loginView) {
    loginView.classList.remove('hidden');
    loginView.setAttribute('aria-hidden', 'false');
  }

  // WICHTIG: auth-container sichtbar machen
  const authContainer = document.getElementById('auth-container');
  if (authContainer) {
    authContainer.classList.remove('hidden');
    authContainer.setAttribute('aria-hidden', 'false');
  }

  // Benutzername leeren
  const userNameSpan = document.getElementById('user-name');
  if (userNameSpan) userNameSpan.textContent = '';

  // Buttons zur√ºcksetzen, falls definiert
  if (typeof clockInBtn !== 'undefined') clockInBtn.disabled = false;
  if (typeof clockOutBtn !== 'undefined') clockOutBtn.disabled = true;

  // QR-Code-Generator verstecken
  const qrGen = document.getElementById('qr-generator-section');
  if (qrGen) qrGen.classList.add('hidden');

  // Bottom-Navigation ausblenden
  const bottomNav = document.getElementById('bottom-nav');
  if (bottomNav) bottomNav.classList.add('hidden');

  // Logout-Button verstecken
  if (typeof logoutBtn !== 'undefined') logoutBtn.classList.add('hidden');

  // QR-Scanner ggf. neu starten
  if (typeof initQRScanner === 'function') {
    initQRScanner();
  }
}

// === Logout ===
logoutBtn.addEventListener('click', async () => {
  try {
    await apiFetch('/api/logout', { method: 'POST' });
    handleLogoutCleanup();
    alert('Logout erfolgreich!');
  } catch (err) {
    console.error(err);
    alert('Logout Fehler: ' + err.message);
  }
});

// === Register-Link im Login-Form ===
showRegisterBtn.addEventListener('click', () => {
  showSection(registerSection);
});

// === Zur√ºck zum Login ===
showLoginBtn.addEventListener('click', () => {
  showSection(loginSection);
});

// === Registrierung ===
registerForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();

  const vorname = registerForm['firstname'].value.trim();
  const nachname = registerForm['lastname'].value.trim();
  const email = registerForm['email'].value.trim();
  const passwort = registerForm['passwort'].value.trim();

  try {
    const res = await apiFetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ vorname, nachname, email, passwort }),
    });

    // Wenn erfolgreich, bekommst du direkt das JSON mit message z.‚ÄØB.
    alert(res.message || 'Registrierung erfolgreich! Bitte einloggen.');
    showSection(loginSection);
  } catch (err) {
    alert(err.message || 'Registrierung fehlgeschlagen.');
  }
});

document.getElementById('show-register-btn').onclick = () => {
  document.getElementById('login-view').classList.add('hidden');
  document.getElementById('register-view').classList.remove('hidden');
};

document.getElementById('show-login-btn').onclick = () => {
  document.getElementById('register-view').classList.add('hidden');
  document.getElementById('login-view').classList.remove('hidden');
};
  
// === Zeit erfassen (Start) ===
// === Zeit erfassen (Start & danach sofort Logout) ===
clockInBtn.addEventListener('click', async () => {
  if (!loggedInUser) {
    alert('Bitte zuerst einloggen');
    return;
  }

  clockInBtn.disabled = true;

  try {
    await apiFetch('/api/zeit', {
      method: 'POST',
      body: JSON.stringify({ aktion: 'start' }),
    });

    alert('‚úÖ Du wurdest erfolgreich eingestempelt.\nDu wirst jetzt ausgeloggt.');

    // Logout durchf√ºhren
    await apiFetch('/api/logout', { method: 'POST' });

    // UI aufr√§umen und zur√ºck zur QR/Loginmaske
    handleLogoutCleanup();
  } catch (err) {
    console.error('Fehler beim Start der Arbeitszeit oder beim Logout:', err);
    alert('Fehler: ' + err.message);
    clockInBtn.disabled = false; // Nur bei Fehler wieder aktivieren
  }
});

// === Zeit erfassen (Stopp) ===
// === Zeit erfassen (Stopp & danach sofort Logout) ===
clockOutBtn.addEventListener('click', async () => {
  if (!loggedInUser) {
    alert('Bitte zuerst einloggen');
    return;
  }

  clockOutBtn.disabled = true;

  try {
    await apiFetch('/api/zeit', {
      method: 'POST',
      body: JSON.stringify({ aktion: 'stop' }),
    });

    alert('‚èπÔ∏è Du wurdest erfolgreich ausgestempelt.\nDu wirst jetzt ausgeloggt.');

    // Logout durchf√ºhren
    await apiFetch('/api/logout', { method: 'POST' });

    // UI aufr√§umen und zur√ºck zur QR/Loginmaske
    handleLogoutCleanup();
  } catch (err) {
    console.error('Fehler beim Stoppen der Arbeitszeit oder beim Logout:', err);
    alert('Fehler beim Stoppen der Arbeitszeit: ' + err.message);
  }
});

  //schon eingestempelt?
async function getLetzterStatus() {
  try {
    const data = await apiFetch('/api/zeit/letzter-status', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
    }, true); // Authentifizierung aktivieren

    console.log('Letzter Zeitstatus:', data);
    return data; // z.B. { aktion: 'start', zeit: '2025-06-09T08:00:00Z' }
  } catch (err) {
    console.error('Fehler beim Abrufen des letzten Status:', err);
    return null;
  }
}
  
  document.addEventListener("DOMContentLoaded", () => {
 
  // Alle Sections als Array (f√ºr showSection)
  const sections = [
    meinTagSection,
    arbeitsplanungSection,
    zeiterfassungSection,
    chatSection,
    settingsSection,
    qrSection
  ].filter(Boolean);

  // === Navigation Button Handler ===
navButtons.forEach((btn) => {
  btn.addEventListener("click", async () => {
    const targetId = btn.dataset.target;

    // Kein Ziel oder gesch√ºtzte Bereiche
    if (!targetId || targetId === "login-view") return;

    // Vorarbeiter d√ºrfen nicht zur QR-Section
    if (targetId === "qr-section" && isVorarbeiterGlobal) return;

    // Special Case: Zeiterfassung
    if (targetId === "zeiterfassung-section") {
      if (isVorarbeiterGlobal) {
        await hideQrGate();
        showSection('zeiterfassung-section');
        setActiveNavButton(btn);
      } else {
        if (qrScanErfolgt) {
          await hideQrGate();
          showSection('zeiterfassung-section');
          setActiveNavButton(btn);
        } else {
          await showQrGate(); // Zeigt QR-Gate, aber kein Sectionwechsel
          setActiveNavButton(null); // Kein Button aktiv
        }
      }
    } else {
      await hideQrGate();

      // QR-Section absichern
      if (isVorarbeiterGlobal && targetId === 'qr-section') return;

      const targetSection = document.getElementById(targetId);
      if (targetSection) {
        showSection(targetSection);
        setActiveNavButton(btn);
      } else {
        console.warn("‚ö†Ô∏è Zielsection nicht gefunden:", targetId);
      }
    }
  });
});

/**
 * Setzt den "active"-Status f√ºr den geklickten Button.
 * Wenn `null` √ºbergeben wird, wird der Status f√ºr alle entfernt.
 */
function setActiveNavButton(activeBtn) {
  navButtons.forEach(btn => btn.classList.remove('active'));
  if (activeBtn) {
    activeBtn.classList.add('active');
  }
}
});
  
</script>

</body>
</html>

