<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zeiterfassung</title>
  <style>
  body {
  font-family: 'Inter', sans-serif;
  margin: 0; padding: 0;
  background: var(--bg, #fff);
  color: var(--fg, #000);
  font-size: 16px;
  line-height: 1.5;
}

[data-theme="dark"] {
  --bg: #121212;
  --fg: #eee;
  --card-bg: #222;
}

header {
  background: #4CAF50;
  color: white;
  padding: 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1.2rem;
}

main {
  max-width: 100%;
  margin: 0 auto;
  padding: 1rem;
  box-sizing: border-box;
}

.card {
  background: var(--card-bg, #f9f9f9);
  padding: 1rem;
  margin-bottom: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
}

.hidden {
  display: none !important;
}

label {
  display: block;
  margin-top: 1rem;
  font-weight: 500;
}

input[type="email"],
input[type="password"],
input[type="text"] {
  width: 100%;
  padding: 0.8rem;
  margin-top: 0.4rem;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1rem;
  box-sizing: border-box;
}

button {
  display: block;
  width: 100%;
  margin-top: 1.2rem;
  padding: 0.9rem;
  font-size: 1.05rem;
  border-radius: 6px;
  background: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
  transition: background 0.2s ease;
}

button:hover {
  background: #45a049;
}

button:disabled {
  background: #999;
  cursor: not-allowed;
}

.link {
  text-align: center;
  margin-top: 1rem;
}

.link button {
  background: none;
  border: none;
  color: #4CAF50;
  text-decoration: underline;
  font-size: 1rem;
  padding: 0.4rem;
}

#bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background: #f2f2f2;
  border-top: 1px solid #ccc;
  padding: 0.5rem 0;
  z-index: 1000;
}

#bottom-nav button {
  background: none;
  border: none;
  font-size: 1.5rem;
  padding: 0.4rem;
  color: #333;
}

#bottom-nav .main-button {
  font-size: 2rem;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  padding: 0.6rem;
  margin-top: -1.2rem;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

#auth-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: calc(100vh - 100px); /* Platz f√ºr Header */
  padding: 2rem 1rem;
}

#auth-container section.view {
  width: 100%;
  max-width: 400px;
  background: var(--card-bg, #f9f9f9);
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
  transition: opacity 0.3s ease;
}

#auth-container section.view.hidden {
  display: none;
}
    
.view {
  margin-bottom: 4rem; /* Abstand zur Bottom-Nav */
}

/* Optional: Media-Query f√ºr sehr kleine Ger√§te */
@media (max-width: 360px) {
  header h1 {
    font-size: 1.1rem;
  }

  button {
    font-size: 0.95rem;
    padding: 0.75rem;
  }

  label {
    font-size: 0.95rem;
  }

  input {
    font-size: 0.95rem;
  }
}

  </style>
</head>
</body>

<header role="banner" style="position: relative;">
  <h1 style="flex-grow:1;">Zeiterfassung</h1>
</header>

<main role="main" aria-live="polite">

<!-- Auth-H√ºlle -->
<div id="auth-container">
  <!-- Login-Ansicht -->
  <section id="login-view" class="view">
    <h2>Login</h2>
    <form id="login-form">
      <input name="email" type="email" required />
      <input name="passwort" type="password" required />
      <button type="submit">Einloggen</button>
    </form>
    <button id="show-register-btn">Noch kein Konto?</button>
  </section>

  <!-- Registrierung -->
  <section id="register-view" class="view hidden">
    <h2>Registrieren</h2>
    <form id="register-form">
      <input name="firstname" placeholder="Vorname" required />
      <input name="lastname" placeholder="Nachname" required />
      <input name="email" placeholder="E-Mail" type="email" required />
      <input name="passwort" placeholder="Passwort" type="password" required />
      <button type="submit">Registrieren</button>
    </form>
    <button id="show-login-btn">Zur√ºck zum Login</button>
  </section>
</div>

  <!-- App-Ansicht nach Login -->
  <div id="app-view" class="hidden">

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" aria-label="Hauptnavigation">
      <button data-target="mein-tag-section" aria-label="Mein Tag">üè†</button>
      <button data-target="arbeitsplanung-section" aria-label="Arbeitsplanung">üë∑‚Äç‚ôÇÔ∏è</button>
      <button data-target="zeiterfassung-section" aria-label="Zeiterfassung" class="main-button">üì∑</button>
      <button data-target="chat-section" aria-label="Chat">üí¨</button>
      <button data-target="settings-section" aria-label="Einstellungen">‚öôÔ∏è</button>
    </nav>

    <!-- 1. Mein Tag -->
    <section id="mein-tag-section" class="card view" aria-label="Mein Tag">
      <h2>Mein Tag</h2>
      <p>Hier siehst du deinen heutigen Einsatz.</p>
            <div class="user-info">
  Angemeldet als: <span id="user-name">‚Ä¶</span>
</div>
    </section>

    <!-- 2. Arbeitsplanung -->
    <section id="arbeitsplanung-section" class="card view hidden" aria-label="Arbeitsplanung">
      <h2>Arbeitsplanung</h2>
      <p>(Hier kommt sp√§ter die Einsatzplanung hin)</p>
    </section>

    <!-- 3. Zeiterfassung (inkl. QR-Scanner) -->
<!-- 3. Zeiterfassung (inkl. QR-Scanner und ggf. QR-Generator f√ºr Vorarbeiter) -->
<section id="zeiterfassung-section" class="card view hidden" aria-label="Zeiterfassung">
  <h2>Zeiterfassung</h2>

  <button id="clock-in-btn" type="button">Einstempeln (Start)</button>
  <button id="clock-out-btn" type="button" disabled>Ausstempeln (Stop)</button>

  <p id="time-message"></p>

  <div id="qr-reader" style="margin-top: 2rem;"></div>
  <p id="qr-message"></p>

  <!-- QR-Code Generator (nur sichtbar f√ºr Vorarbeiter) -->
  <div id="qr-generator-container" class="hidden" style="margin-top: 2rem;">
    <h3>QR-Code f√ºr Arbeiter</h3>
    <button id="generate-qr-btn" type="button">QR-Code generieren (15 Min g√ºltig)</button>
    <div id="qr-container" style="margin-top: 1rem;"></div>
    <p id="qr-valid-until" style="font-size: 0.9rem; color: #555;"></p>
  </div>

  <button id="logout-btn" type="button" style="margin-top:2rem; background:#e74c3c; color:#fff;">
    Ausloggen
  </button>
</section>

    <!-- 4. Chat -->
    <section id="chat-section" class="card view hidden" aria-label="Chat">
      <h2>Chat</h2>
      <p>Kommunikation mit Vorarbeitern und Verwaltung</p>
    </section>

    <!-- 5. Einstellungen -->
    <section id="settings-section" class="card view hidden" aria-label="Einstellungen">
      <h2>Einstellungen</h2>
      <label for="darkmode-switch-main">
        <input type="checkbox" id="darkmode-switch-main" />
        Dark Mode
      </label>
    </section>

  </div>

</main>
<!-- QR-Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- QR-Code-Generator Bibliothek -->
<!-- Stelle sicher, dass diese Bibliothek eingebunden ist -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  
<script type="module">
  import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm";

 document.addEventListener('DOMContentLoaded', () => {
  const generateBtn = document.getElementById('generate-qr-btn');
  const qrContainer = document.getElementById('qr-container');
  const qrValidUntil = document.getElementById('qr-valid-until');

  if (!generateBtn || !qrContainer || !qrValidUntil) {
    console.warn('‚ö†Ô∏è QR-Code-UI-Element(e) fehlen: Button, Container oder G√ºltigkeitsanzeige nicht gefunden.');
    return;
  }

  generateBtn.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/qr/create', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': csrfToken,
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });

      if (!res.ok) {
        console.error('‚ùå QR-Code konnte nicht generiert werden ‚Äì Serverfehler:', res.status);
        alert('Fehler beim QR-Code-Generieren');
        return;
      }

      const { qrToken, g√ºltigBis } = await res.json();
      const cleanToken = qrToken.trim();
      console.log('‚ñ∂Ô∏è QR-Inhalt:', cleanToken);

      const canvas = document.createElement('canvas');
      await QRCode.toCanvas(canvas, cleanToken, {
        width: 256,
        margin: 1,
        color: {
          dark: '#000000',
          light: '#ffffff',
        },
        errorCorrectionLevel: 'M'
      });

      qrContainer.innerHTML = '';
      qrContainer.appendChild(canvas);

      const validUntil = new Date(g√ºltigBis).toLocaleTimeString();
      qrValidUntil.textContent = `G√ºltig bis: ${validUntil}`;
    } catch (err) {
      console.error('‚ùå Fehler beim Erzeugen des QR-Codes:', err);
      alert('Fehler beim Abrufen des QR-Codes.');
    }
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const darkmodeSwitch = document.getElementById('darkmode-switch-main');
  if (!darkmodeSwitch) {
    console.warn('‚ö†Ô∏è Darkmode-Switch #darkmode-switch-main nicht gefunden.');
    return;
  }

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    darkmodeSwitch.checked = theme === 'dark';
  }

  // Gespeicherten Wert oder Systemvoreinstellung laden
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    setTheme(savedTheme);
  } else {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }

  // Umschalten
  darkmodeSwitch.addEventListener('change', () => {
    setTheme(darkmodeSwitch.checked ? 'dark' : 'light');
  });
});

// Zeitstatus pr√ºfen
document.addEventListener('DOMContentLoaded', async () => {
  const token = sessionStorage.getItem('accessToken');
  if (!token) {
    console.warn('‚õî Kein accessToken in sessionStorage ‚Äì Statuspr√ºfung √ºbersprungen.');
    return;
  }

  try {
    const status = await getLetzterStatus();

    const clockInBtn = document.getElementById('clock-in-btn');
    const clockOutBtn = document.getElementById('clock-out-btn');

    if (!clockInBtn || !clockOutBtn) {
      console.warn('‚ö†Ô∏è Clock-In oder Clock-Out Button nicht im DOM gefunden.');
      return;
    }

    const eingestempelt = status?.eingestempelt;

    if (eingestempelt === true) {
      clockInBtn.disabled = true;
      clockOutBtn.disabled = false;
    } else if (eingestempelt === false) {
      clockInBtn.disabled = false;
      clockOutBtn.disabled = true;
    } else {
      console.warn('‚ö†Ô∏è Ung√ºltiger Statuswert:', eingestempelt);
      clockInBtn.disabled = false;
      clockOutBtn.disabled = false;
    }
  } catch (err) {
    console.error('‚ùå Fehler beim Abrufen des letzten Zeitstatus:', err);
  }
});

// API-Konstanten
const BASE = '/api';
const API_BASE = '/api';
const API_BASE_URL = '';

// DOM-Elemente
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterBtn = document.getElementById('show-register-btn');
const showLoginBtn = document.getElementById('show-login-btn');
const logoutBtn = document.getElementById('logout-btn');

const userNameSpan = document.getElementById('user-name');
const clockInBtn = document.getElementById('clock-in-btn');
const clockOutBtn = document.getElementById('clock-out-btn');

//Navbar button
const zeiterfassungBtn = document.querySelector('button.main-button[data-target="zeiterfassung-section"]');
  
// Settings (Dropdown oben rechts)
const darkModeSwitch = document.getElementById('darkmode-switch-main');

// Bereiche / Views
const qrSection = document.getElementById('qr-generator-section'); // Generator f√ºr Vorarbeiter
const loginSection = document.getElementById('login-view');
const registerSection = document.getElementById('register-view');
const timeTrackingSection = document.getElementById('zeiterfassung-section');

const qrReaderElem = document.getElementById('qr-reader');
const qrMessage = document.getElementById('qr-message');

const loginEmail = document.getElementById('login-email');
const loginPassword = document.getElementById('login-password');
const loginError = document.getElementById('login-error');

// Session-Zustand
let csrfToken = localStorage.getItem('csrfToken') || '';
let loggedInUser = null;

// Hilfsfunktion: Cookie auslesen
function getCookie(name) {
  const cookies = document.cookie.split(';').map(c => c.trim());
  for (const cookie of cookies) {
    if (cookie.startsWith(name + '=')) {
      return decodeURIComponent(cookie.substring(name.length + 1));
    }
  }
  return null;
}

// Haupt-Fetch mit automatischem Token-Refresh, CSRF-Token und Auth-Header
async function apiFetch(path, options = {}, useAuthHeaderToken = false) {
  const method = (options.method || 'GET').toUpperCase();
  const writeMethods = ['POST', 'PUT', 'DELETE', 'PATCH'];

  options = { ...options };
  options.headers = options.headers || {};
  options.credentials = 'include'; // zwingend, damit Cookies gesendet werden

  // CSRF-Token f√ºr schreibende Methoden aus localStorage setzen
if (writeMethods.includes(method)) {
  // Content-Type setzen, wenn noch nicht gesetzt
  if (!options.headers['Content-Type']) {
    options.headers['Content-Type'] = 'application/json';
  }

  if (!csrfToken) {
    console.warn('‚ö†Ô∏è Kein CSRF-Token im localStorage gefunden.');
  } else {
    options.headers['X-CSRF-Token'] = csrfToken;
  }
}


  if (useAuthHeaderToken) {
    const token = getCookie('token');
    if (token) {
      options.headers['Authorization'] = 'Bearer ' + token;
    }
  }

const url = path.startsWith('http') ? path : (API_BASE_URL + path);

  async function fetchWithCookies() {
    return fetch(url, options);
  }

  let response = await fetchWithCookies();

   if (response.status === 401) {
    const refreshResponse = await fetch(`${API_BASE_URL}/api/refresh`, {
      method: 'POST',
      credentials: 'include',
    });

    if (!refreshResponse.ok) {
      throw new Error('Token-Refresh fehlgeschlagen. Bitte neu einloggen.');
    }

    response = await fetchWithCookies();

    if (response.status === 401) {
      throw new Error('Token-Refresh fehlgeschlagen. Bitte neu einloggen.');
    }
  }

  if (!response.ok) {
    let errorMsg = `Fehler: HTTP ${response.status}`;
    try {
      const errJson = await response.json();
      if (errJson.error) errorMsg = errJson.error;
      else if (errJson.message) errorMsg = errJson.message;
    } catch {
      const errText = await response.text().catch(() => '');
      if (errText) errorMsg = errText;
    }
    throw new Error(errorMsg);
  }

  try {
    return await response.json();
  } catch {
    return {};
  }
}
  
// Login-Funktion: speichert Access- und CSRF-Token
async function login(email, passwort) {
  if (!email || !passwort) {
    alert('Bitte Email und Passwort ausf√ºllen!');
    return;
  }

  try {
    const res = await apiFetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, passwort }),
    });

    if (!res.user) {
      alert('Login erfolgreich, aber kein Benutzerobjekt erhalten.');
      return;
    }

    console.log('‚úÖ Eingeloggt:', res.user);

    if (res.csrfToken) {
      localStorage.setItem('csrfToken', res.csrfToken);
      csrfToken = res.csrfToken;
    }

    loggedInUser = res.user;

    if (res.user.rolle === 'vorarbeiter') {
      console.log('Vorarbeiter eingeloggt, Vorarbeiter-Token wurde serverseitig gesetzt');
    }

    // UI anpassen:
    await updateUIAfterLogin(res.user);

  } catch (err) {
    console.error('‚ùå Login fehlgeschlagen:', err.message);
    alert('Login fehlgeschlagen: ' + err.message);
  }
}
  
loginForm.addEventListener('submit', async (event) => {
  event.preventDefault();  // Verhindert das Neuladen der Seite

  const email = loginForm.email.value;     // Annahme: <input name="email">
  const passwort = loginForm.passwort.value; // Annahme: <input name="passwort">

  try {
    await login(email, passwort);  // Deine bereits bestehende login-Funktion
  } catch (err) {
    console.error('Login fehlgeschlagen:', err);
  }
});
  
async function updateProfile() {
  try {
    const user = await apiFetch('/api/me', {}, true);  // optional: mit Authorization
    loggedInUser = user;
   
    updateUIAfterLogin(user); // ‚¨ÖÔ∏è hier √úbergabe fixen!
  } catch (err) {
    console.error('Profil konnte nicht geladen werden:', err);
    handleLogoutCleanup();
  }
}
  
// === Sections anzeigen ===
function showSection(section) {
  if (!section) {
    console.error("‚ùå showSection: √úbergabe-Section ist null oder undefiniert!");
    return;
  }

  // Alle "App-Views" verstecken, also alle Sektionen innerhalb #app-view mit Klasse view
  const appView = document.getElementById('app-view');
  if (appView) {
    appView.querySelectorAll('.view').forEach(s => {
      s.classList.add('hidden');
      s.setAttribute('aria-hidden', 'true');
    });
  }

  // Zeige die gew√ºnschte Section (egal ob Login/Register oder App-View)
  section.classList.remove('hidden');
  section.setAttribute('aria-hidden', 'false');
}

// === QR Scanner ===
const config = {
  fps: 10,
  qrbox: 250,
};

let scannerIsRunning = false;
let html5QrCode = null;

// QR-Scanner starten und anzeigen
async function showQrGate() {
  qrSection.classList.remove('hidden');
  qrSection.setAttribute('aria-hidden', 'false');

  await startQrScanner();
}

// QR-Gate ausblenden
function hideQrGate() {
  qrSection.classList.add('hidden');
  qrSection.setAttribute('aria-hidden', 'true');

  stopQrScanner(); // Scanner stoppen, falls aktiv
}

// Event-Listener f√ºr Navigation
document.querySelectorAll('#bottom-nav button').forEach(btn => {
  btn.addEventListener('click', async (ev) => {
    const targetId = btn.getAttribute('data-target');
    if (!targetId) return;

    // Wenn Ziel Zeiterfassung ist
    if (targetId === 'zeiterfassung-section') {
      if (qrScanErfolgt) {
        hideQrGate();
        showSection(timeTrackingSection);
      } else {
        // QR-Gate zeigen, Zeiterfassung noch nicht
        await showQrGate();
      }
    } else {
      // Andere Section: QR-Gate verstecken, Ziel anzeigen
      hideQrGate();

      const targetSection = document.getElementById(targetId);
      if (targetSection) {
        showSection(targetSection);
      }
    }
  });
});

// QR-Scan erfolgreich ‚Äì Status setzen und QR-Gate ausblenden
async function onQrCodeDetected(decodedText) {
  try {
    console.log("‚û°Ô∏è QR-Code erkannt:", decodedText);
    await validateQrCode(decodedText);

    console.log("‚úÖ QR-Code g√ºltig ‚Äì Gate passiert.");
    qrScanErfolgt = true;

    hideQrGate();
    showSection(timeTrackingSection);
  } catch (err) {
    console.warn("‚õî QR ung√ºltig:", err.message);
    alert("Ung√ºltiger QR-Code: " + err.message);
    await startQrScanner();
  }
}

// Wird aufgerufen, wenn QR-Code erkannt wurde
async function onQrCodeDetected(decodedText) {
  try {
    console.log("‚û°Ô∏è QR-Code erkannt:", decodedText);
    await validateQrCode(decodedText);

    console.log("‚úÖ QR-Code g√ºltig ‚Äì Zeiterfassung wird ge√∂ffnet.");
    qrScanErfolgt = true;  // Setze Status, dass QR gescannt wurde

    // Verstecke QR-Scan-Bereich
    qrSection.classList.add('hidden');
    qrSection.setAttribute('aria-hidden', 'true');

    // Zeige Zeiterfassungsbereich
    showSection(timeTrackingSection);
  } catch (err) {
    console.warn("‚õî QR ung√ºltig:", err.message);
    alert("Ung√ºltiger QR-Code: " + err.message);
    await startQrScanner();  // Scanner neu starten
  }
}

async function startQrScanner() {
  if (scannerIsRunning) {
    console.warn("Scanner l√§uft schon, Start √ºbersprungen");
    return;
  }

  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("qr-reader");
  }

  try {
    scannerIsRunning = true;
    await html5QrCode.start(
      { facingMode: "environment" },
      config,
      async (decodedText, decodedResult) => {
        console.log("QR-Code erkannt:", decodedText);
        await stopQrScanner();
        await onQrCodeDetected(decodedText);
      }
    );
  } catch (error) {
    console.error("Fehler beim Starten des QR-Scanners:", error);
    scannerIsRunning = false;
  }
}

async function stopQrScanner() {
  if (!scannerIsRunning) {
    console.warn("Scanner l√§uft nicht, Stop √ºbersprungen");
    return;
  }

  try {
    await html5QrCode.stop();
    console.log("QR-Scanner gestoppt");
  } catch (err) {
    console.error("Fehler beim Stoppen des QR-Scanners:", err);
  } finally {
    scannerIsRunning = false;
  }
}

async function validateQrCode(qr) {
  const csrfToken = localStorage.getItem('csrfToken'); // oder aus Cookie extrahieren, je nach Implementierung

  const res = await fetch(`${API_BASE}/validate-qr`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
    credentials: 'include',
    body: JSON.stringify({ qr }),
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || 'Ung√ºltiger QR-Code');
  }

  return await res.json();
}

 function showPopupMessage(msg, duration = 3000) {
  const popup = document.getElementById('popup-message');
  popup.textContent = msg;
  popup.classList.remove('hidden');

  setTimeout(() => {
    popup.classList.add('hidden');
  }, duration);
}

// === Helper Funktionen zur Base64-URL-Konvertierung (f√ºr WebAuthn) ===
function base64urlToUint8Array(base64urlString) {
  const padding = '='.repeat((4 - (base64urlString.length % 4)) % 4);
  const base64 = (base64urlString + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

function toBase64Url(buffer) {
  const bytes = new Uint8Array(buffer);
  let str = '';
  for (let i = 0; i < bytes.byteLength; i++) {
    str += String.fromCharCode(bytes[i]);
  }
  return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// === UI Aktualisierung nach Login ===
async function updateUIAfterLogin(user) {
  console.log("üîê updateUIAfterLogin aufgerufen:", user);

  if (!user) {
    console.warn('‚ö†Ô∏è Kein Benutzerobjekt √ºbergeben an updateUIAfterLogin');
    return;
  }

  loggedInUser = user;
  const isVorarbeiter = user.rolle === 'vorarbeiter';

  // Benutzername anzeigen
  const nameEl = document.getElementById('user-name');
  if (nameEl) {
    nameEl.textContent = user.name || user.email || 'Benutzer';
  }

  // Auth-Container verstecken
  const authContainer = document.getElementById('auth-container');
  if (authContainer) {
    authContainer.classList.add('hidden');
    authContainer.setAttribute('aria-hidden', 'true');
  }

  // App-View anzeigen
  const appView = document.getElementById('app-view');
  if (appView) {
    appView.classList.remove('hidden');
    appView.setAttribute('aria-hidden', 'false');
  }

  // Zeiterfassungsansicht aktivieren
  showSection(timeTrackingSection);

  // Logout sichtbar machen
  if (logoutBtn) {
    logoutBtn.classList.remove('hidden');
  }

  // Bottom-Navigation anzeigen
  const bottomNav = document.getElementById('bottom-nav');
  if (bottomNav) {
    bottomNav.classList.remove('hidden');
  }

  // QR-Generator nur f√ºr Vorarbeiter sichtbar
  const qrGen = document.getElementById('qr-generator-container');
  if (qrGen) {
    qrGen.classList.toggle('hidden', !isVorarbeiter);
    qrGen.setAttribute('aria-hidden', !isVorarbeiter);
  }

  // QR-Scanner nur f√ºr normale Nutzer sichtbar
  const qrReader = document.getElementById('qr-reader');
  if (qrReader) {
    qrReader.classList.toggle('hidden', isVorarbeiter);
    qrReader.setAttribute('aria-hidden', isVorarbeiter);
  }

  // Buttons aktivieren/deaktivieren
  if (typeof clockInBtn !== 'undefined') clockInBtn.disabled = false;
  if (typeof clockOutBtn !== 'undefined') clockOutBtn.disabled = true;

  // Weitere Login-spezifische UI-Anpassungen ggf. hier
}

// === Logout Cleanup ===
function handleLogoutCleanup() {
  loggedInUser = null;

  const loginForm = document.getElementById('login-form');
  if (loginForm) {
    if (loginForm['email']) loginForm['email'].value = '';
    if (loginForm['passwort']) loginForm['passwort'].value = '';
  }

  // Tokens aus Speicher l√∂schen
  sessionStorage.removeItem('accessToken');
  localStorage.removeItem('csrfToken');
  document.cookie = 'csrfToken=; Max-Age=0; path=/; secure; SameSite=None';

  // Alle Haupt-Sections ausblenden, au√üer Login-View
  [
    document.getElementById('qr-section'),
    document.getElementById('register-view'),
    document.getElementById('time-tracking-section'),
    document.getElementById('mein-tag-section'),
    document.getElementById('arbeitsplanung-section'),
    document.getElementById('zeiterfassung-section'),
    document.getElementById('chat-section'),
    document.getElementById('settings-section'),
    document.getElementById('qr-generator-section')
  ].filter(Boolean).forEach(sec => {
    if (sec.id !== 'login-view') {
      sec.classList.add('hidden');
      sec.setAttribute('aria-hidden', 'true');
    }
  });

  // Login-View anzeigen
  const loginView = document.getElementById('login-view');
  if (loginView) {
    loginView.classList.remove('hidden');
    loginView.setAttribute('aria-hidden', 'false');
  }

  // WICHTIG: auth-container sichtbar machen
  const authContainer = document.getElementById('auth-container');
  if (authContainer) {
    authContainer.classList.remove('hidden');
    authContainer.setAttribute('aria-hidden', 'false');
  }

  // Benutzername leeren
  const userNameSpan = document.getElementById('user-name');
  if (userNameSpan) userNameSpan.textContent = '';

  // Buttons zur√ºcksetzen, falls definiert
  if (typeof clockInBtn !== 'undefined') clockInBtn.disabled = false;
  if (typeof clockOutBtn !== 'undefined') clockOutBtn.disabled = true;

  // QR-Code-Generator verstecken
  const qrGen = document.getElementById('qr-generator-section');
  if (qrGen) qrGen.classList.add('hidden');

  // Bottom-Navigation ausblenden
  const bottomNav = document.getElementById('bottom-nav');
  if (bottomNav) bottomNav.classList.add('hidden');

  // Logout-Button verstecken
  if (typeof logoutBtn !== 'undefined') logoutBtn.classList.add('hidden');

  // QR-Scanner ggf. neu starten
  if (typeof initQRScanner === 'function') {
    initQRScanner();
  }
}

// === Logout ===
logoutBtn.addEventListener('click', async () => {
  try {
    await apiFetch('/api/logout', { method: 'POST' });
    handleLogoutCleanup();
    alert('Logout erfolgreich!');
  } catch (err) {
    console.error(err);
    alert('Logout Fehler: ' + err.message);
  }
});

// === Register-Link im Login-Form ===
showRegisterBtn.addEventListener('click', () => {
  showSection(registerSection);
});

// === Zur√ºck zum Login ===
showLoginBtn.addEventListener('click', () => {
  showSection(loginSection);
});

// === Registrierung ===
registerForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();

  const vorname = registerForm['firstname'].value.trim();
  const nachname = registerForm['lastname'].value.trim();
  const email = registerForm['email'].value.trim();
  const passwort = registerForm['passwort'].value.trim();

  try {
    const res = await apiFetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ vorname, nachname, email, passwort }),
    });

    // Wenn erfolgreich, bekommst du direkt das JSON mit message z.‚ÄØB.
    alert(res.message || 'Registrierung erfolgreich! Bitte einloggen.');
    showSection(loginSection);
  } catch (err) {
    alert(err.message || 'Registrierung fehlgeschlagen.');
  }
});

document.getElementById('show-register-btn').onclick = () => {
  document.getElementById('login-view').classList.add('hidden');
  document.getElementById('register-view').classList.remove('hidden');
};

document.getElementById('show-login-btn').onclick = () => {
  document.getElementById('register-view').classList.add('hidden');
  document.getElementById('login-view').classList.remove('hidden');
};
  
// === Zeit erfassen (Start) ===
// === Zeit erfassen (Start & danach sofort Logout) ===
clockInBtn.addEventListener('click', async () => {
  if (!loggedInUser) {
    alert('Bitte zuerst einloggen');
    return;
  }

  clockInBtn.disabled = true;

  try {
    await apiFetch('/api/zeit', {
      method: 'POST',
      body: JSON.stringify({ aktion: 'start' }),
    });

    alert('‚úÖ Du wurdest erfolgreich eingestempelt.\nDu wirst jetzt ausgeloggt.');

    // Logout durchf√ºhren
    await apiFetch('/api/logout', { method: 'POST' });

    // UI aufr√§umen und zur√ºck zur QR/Loginmaske
    handleLogoutCleanup();
  } catch (err) {
    console.error('Fehler beim Start der Arbeitszeit oder beim Logout:', err);
    alert('Fehler: ' + err.message);
    clockInBtn.disabled = false; // Nur bei Fehler wieder aktivieren
  }
});

// === Zeit erfassen (Stopp) ===
// === Zeit erfassen (Stopp & danach sofort Logout) ===
clockOutBtn.addEventListener('click', async () => {
  if (!loggedInUser) {
    alert('Bitte zuerst einloggen');
    return;
  }

  clockOutBtn.disabled = true;

  try {
    await apiFetch('/api/zeit', {
      method: 'POST',
      body: JSON.stringify({ aktion: 'stop' }),
    });

    alert('‚èπÔ∏è Du wurdest erfolgreich ausgestempelt.\nDu wirst jetzt ausgeloggt.');

    // Logout durchf√ºhren
    await apiFetch('/api/logout', { method: 'POST' });

    // UI aufr√§umen und zur√ºck zur QR/Loginmaske
    handleLogoutCleanup();
  } catch (err) {
    console.error('Fehler beim Stoppen der Arbeitszeit oder beim Logout:', err);
    alert('Fehler beim Stoppen der Arbeitszeit: ' + err.message);
  }
});

  //schon eingestempelt?
async function getLetzterStatus() {
  try {
    const data = await apiFetch('/api/zeit/letzter-status', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
    }, true); // Authentifizierung aktivieren

    console.log('Letzter Zeitstatus:', data);
    return data; // z.B. { aktion: 'start', zeit: '2025-06-09T08:00:00Z' }
  } catch (err) {
    console.error('Fehler beim Abrufen des letzten Status:', err);
    return null;
  }
}
  
// === Initial Setup ===
async function init() {
  if (!clockInBtn || !clockOutBtn) {
    console.warn('‚ö†Ô∏è ClockIn/ClockOut Button nicht gefunden.');
    return;
  }

  // Start-Section anzeigen: Login / QR
  showSection(qrSection);

  // QR-Scanner starten (falls Funktion vorhanden)
  if (typeof startQrScanner === 'function') {
    await startQrScanner();
  }

  // Status abfragen und Buttons anpassen
  try {
    const status = await getLetzterStatus();
    if (status?.aktion === 'start' || status?.eingestempelt === true) {
      clockInBtn.disabled = true;
      clockOutBtn.disabled = false;
    } else {
      clockInBtn.disabled = false;
      clockOutBtn.disabled = true;
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Status konnte nicht geladen werden:', err.message);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  init();

  // Navigation-Setup
  const navButtons = document.querySelectorAll('#bottom-nav button');
  if (!navButtons.length) {
    console.warn('‚ö†Ô∏è Keine Navigations-Buttons gefunden.');
    return;
  }

  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.dataset.target;
      if (!targetId) {
        console.warn('‚ö†Ô∏è Kein data-target-Attribut vorhanden.');
        return;
      }

      // Alle Views verstecken
      document.querySelectorAll('.view').forEach(sec => {
        sec.classList.add('hidden');
        sec.setAttribute('aria-hidden', 'true');
      });

      // qrSection (login) aus der Navigation ausschlie√üen
      if (targetId === 'login-view' || targetId === 'qr-section') {
        console.warn('‚ö†Ô∏è Login/QR-Section ist nicht √ºber Navigation erreichbar.');
        return;
      }

      // Gew√ºnschte Section anzeigen
      const targetSection = document.getElementById(targetId);
      if (!targetSection) {
        console.warn(`‚ö†Ô∏è Ziel-Section mit ID "${targetId}" nicht gefunden.`);
        return;
      }

      targetSection.classList.remove('hidden');
      targetSection.setAttribute('aria-hidden', 'false');
    });
  });
});

let qrScanErfolgt = false; // globaler Status, ob QR gescannt wurde

zeiterfassungBtn.addEventListener('click', () => {
  const isVorarbeiter = loggedInUser?.rolle === 'vorarbeiter';

  if (!isVorarbeiter && !qrScanErfolgt) {
    alert("Bitte QR-Code scannen, bevor du dich einstempelst.");
    showSection(qrSection);
    startQrScanner();
    return;
  }

  // Wenn QR-Scan erfolgt oder Vorarbeiter
  showSection(timeTrackingSection);
});
        
async function fetchUserProfile() {
  const response = await apiFetch('/api/me');
  if (!response.ok) throw new Error('Benutzerdaten konnten nicht geladen werden');
  const user = await response.json();
  return user;
}
  
</script>

</body>
</html>
