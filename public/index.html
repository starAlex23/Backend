<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zeiterfassung</title>
  <style>
   body {
  font-family: 'Inter', sans-serif;
  margin: 0; padding: 0;
  background: var(--bg, #fff);
  color: var(--fg, #000);
  font-size: 16px;
  line-height: 1.5;
}

[data-theme="dark"] {
  --bg: #121212;
  --fg: #eee;
  --card-bg: #222;
}

header {
  background: #4CAF50;
  color: white;
  padding: 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1.2rem;
}

main {
  max-width: 100%;
  margin: 0 auto;
  padding: 1rem;
  box-sizing: border-box;
}

.card {
  background: var(--card-bg, #f9f9f9);
  padding: 1rem;
  margin-bottom: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
}

.hidden {
  display: none !important;
}

label {
  display: block;
  margin-top: 1rem;
  font-weight: 500;
}

input[type="email"],
input[type="password"],
input[type="text"] {
  width: 100%;
  padding: 0.8rem;
  margin-top: 0.4rem;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1rem;
  box-sizing: border-box;
}

button {
  display: block;
  width: 100%;
  margin-top: 1.2rem;
  padding: 0.9rem;
  font-size: 1.05rem;
  border-radius: 6px;
  background: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
  transition: background 0.2s ease;
}

button:hover {
  background: #45a049;
}

button:disabled {
  background: #999;
  cursor: not-allowed;
}

.link {
  text-align: center;
  margin-top: 1rem;
}

.link button {
  background: none;
  border: none;
  color: #4CAF50;
  text-decoration: underline;
  font-size: 1rem;
  padding: 0.4rem;
}

#theme-switcher {
  display: none; /* Standard unsichtbar */
  cursor: pointer;
  font-size: 1.5rem;
  user-select: none;
  padding: 0 0.2rem;
}

#theme-switcher.visible {
  display: inline-block; /* sichtbar */
}

#settings-btn,
#theme-switcher {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: background-color 0.2s ease;
  background: #4caf50;
  color: white;
  border: none;
}

#settings-btn:hover,
#theme-switcher:hover {
  background-color: rgba(255, 255, 255, 0.2);
  cursor: pointer;
}

#settings-dropdown {
  user-select: none;
  color: var(--fg, #000);
  background: var(--card-bg, #f9f9f9);
  position: absolute;
  top: 3.5rem;
  right: 0.5rem;
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  width: 150px;
  z-index: 100;
}

#popup-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: var(--color-bg-popup, #222);
  color: var(--color-text-popup, #eee);
  padding: 1.5rem 2rem;
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(0,0,0,0.7);
  font-size: 1.2rem;
  z-index: 10000;
  opacity: 0.95;
  transition: opacity 0.3s ease;
  pointer-events: none;
  max-width: 90%;
  text-align: center;
}

#popup-message.hidden {
  display: none;
  opacity: 0;
  pointer-events: none;
}

#bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background: #f2f2f2;
  border-top: 1px solid #ccc;
  padding: 0.5rem 0;
  z-index: 1000;
}

#bottom-nav button {
  background: none;
  border: none;
  font-size: 1.5rem;
  padding: 0.4rem;
  color: #333;
}

#bottom-nav .main-button {
  font-size: 2rem;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  padding: 0.6rem;
  margin-top: -1.2rem;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

.view {
  margin-bottom: 4rem; /* Abstand zur Bottom-Nav */
}
    
/* Optional: Media-Query f√ºr sehr kleine Ger√§te */
@media (max-width: 360px) {
  header h1 {
    font-size: 1.1rem;
  }

  button {
    font-size: 0.95rem;
    padding: 0.75rem;
  }

  label {
    font-size: 0.95rem;
  }

  input {
    font-size: 0.95rem;
  }
}
  </style>
</head>
</body>

<header role="banner" style="position: relative;">
  <h1 style="flex-grow:1;">Zeiterfassung</h1>

  <button id="settings-btn" aria-label="Einstellungen" title="Einstellungen"
          style="background:none; border:none; cursor:pointer; font-size:1.5rem; padding:0; margin:0 0.5rem; line-height:1;">
    ‚öôÔ∏è
  </button>

  <div id="settings-dropdown" class="hidden" role="menu" aria-label="Einstellungen Men√º">
    <label for="darkmode-switch" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
      <input type="checkbox" id="darkmode-switch" />
      Dark Mode
    </label>
  </div>
</header>

<main role="main" aria-live="polite">

  <!-- Login bleibt Einstiegspunkt -->
  <section id="login-section" class="card" aria-label="Login Formular">
    <h2>Login</h2>
    <form id="login-form" novalidate>
      <label for="login-email">E-Mail</label>
      <input type="email" id="login-email" name="email" required autocomplete="email" />

      <label for="login-password">Passwort</label>
      <input type="password" id="login-password" name="passwort" required autocomplete="current-password" />

      <button type="submit">Einloggen</button>
    </form>

    <div class="link">
      Noch keinen Account? <button id="show-register-btn" type="button">Jetzt registrieren</button>
    </div>

    <p id="login-error" class="error-message"></p>
  </section>

  <!-- Registrierung -->
  <section id="register-section" class="card hidden" aria-label="Registrierung Formular">
    <h2>Registrieren</h2>
    <form id="register-form" novalidate>
      <label for="register-firstname">Vorname</label>
      <input type="text" id="register-firstname" name="firstname" required autocomplete="given-name" />

      <label for="register-lastname">Nachname</label>
      <input type="text" id="register-lastname" name="lastname" required autocomplete="family-name" />

      <label for="register-email">E-Mail</label>
      <input type="email" id="register-email" name="email" required autocomplete="email" />

      <label for="register-password">Passwort</label>
      <input type="password" id="register-password" name="password" required autocomplete="new-password" />

      <button type="submit">Registrieren</button>
    </form>

    <div class="link">
      Schon einen Account? <button id="show-login-btn" type="button">Jetzt einloggen</button>
    </div>

    <div id="logout-message"></div>
  </section>

  <!-- App-Ansicht nach Login -->
  <div id="app-view" class="hidden">

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" aria-label="Hauptnavigation">
      <button data-target="mein-tag-section" aria-label="Mein Tag">üè†</button>
      <button data-target="arbeitsplanung-section" aria-label="Arbeitsplanung">üë∑‚Äç‚ôÇÔ∏è</button>
      <button data-target="zeiterfassung-section" aria-label="Zeiterfassung" class="main-button">üì∑</button>
      <button data-target="chat-section" aria-label="Chat">üí¨</button>
      <button data-target="settings-section" aria-label="Einstellungen">‚öôÔ∏è</button>
    </nav>

    <!-- 1. Mein Tag -->
    <section id="mein-tag-section" class="card view" aria-label="Mein Tag">
      <h2>Mein Tag</h2>
      <p>Hier siehst du deinen heutigen Einsatz.</p>
            <div class="user-info">
  Angemeldet als: <span id="user-name">‚Ä¶</span>
</div>
    </section>

    <!-- 2. Arbeitsplanung -->
    <section id="arbeitsplanung-section" class="card view hidden" aria-label="Arbeitsplanung">
      <h2>Arbeitsplanung</h2>
      <p>(Hier kommt sp√§ter die Einsatzplanung hin)</p>
    </section>

    <!-- 3. Zeiterfassung (inkl. QR-Scanner) -->
    <section id="zeiterfassung-section" class="card view hidden" aria-label="Zeiterfassung">
      <h2>Zeiterfassung</h2>

      <button id="clock-in-btn" type="button">Einstempeln (Start)</button>
      <button id="clock-out-btn" type="button" disabled>Ausstempeln (Stop)</button>

      <p id="time-message"></p>

      <div id="qr-reader" style="margin-top: 2rem;"></div>
      <p id="qr-message"></p>

      <button id="logout-btn" type="button" style="margin-top:2rem; background:#e74c3c; color:#fff;">
        Ausloggen
      </button>
    </section>

    <!-- 4. Chat -->
    <section id="chat-section" class="card view hidden" aria-label="Chat">
      <h2>Chat</h2>
      <p>Kommunikation mit Vorarbeitern und Verwaltung</p>
    </section>

    <!-- 5. Einstellungen -->
    <section id="settings-section" class="card view hidden" aria-label="Einstellungen">
      <h2>Einstellungen</h2>
      <label for="darkmode-switch-main">
        <input type="checkbox" id="darkmode-switch-main" />
        Dark Mode
      </label>
    </section>

    <!-- 6. QR-Code Generator (nur f√ºr Vorarbeiter sichtbar) -->
    <section id="qr-generator-section" class="card view hidden" aria-label="QR-Code f√ºr Arbeiter generieren">
      <h2>QR-Code f√ºr Arbeiter</h2>
      <button id="generate-qr-btn" type="button">QR-Code generieren (15 Min g√ºltig)</button>
      <div id="qr-container" style="margin-top: 1rem;"></div>
      <p id="qr-valid-until" style="font-size: 0.9rem; color: #555;"></p>
    </section>

  </div>

</main>
<!-- QR-Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- QR-Code-Generator Bibliothek -->
<!-- Stelle sicher, dass diese Bibliothek eingebunden ist -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>


<script type="module">
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm";

// Globale Variablen (minimal)
let csrfToken = localStorage.getItem('csrfToken') || '';
let loggedInUser = null;
let html5QrCode = null;
let scannerIsRunning = false;

document.addEventListener('DOMContentLoaded', () => {
  // --- DOM-Elemente ---
  const generateBtn = document.getElementById('generate-qr-btn');
  const qrContainer = document.getElementById('qr-container');
  const qrValidUntil = document.getElementById('qr-valid-until');

  const settingsBtn = document.getElementById('settings-btn');
  const settingsDropdown = document.getElementById('settings-dropdown');
  const darkmodeSwitch = document.getElementById('darkmode-switch');

  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');
  const showRegisterBtn = document.getElementById('show-register-btn');
  const showLoginBtn = document.getElementById('show-login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  const userNameSpan = document.getElementById('user-name');
  const clockInBtn = document.getElementById('clock-in-btn');
  const clockOutBtn = document.getElementById('clock-out-btn');

  const qrSection = document.getElementById('qr-section');
  const loginSection = document.getElementById('login-section');
  const registerSection = document.getElementById('register-section');
  const timeTrackingSection = document.getElementById('time-tracking-section');

  // --- Funktionen ---

  // CSRF Token aktualisieren
  function setCsrfToken(token) {
    csrfToken = token;
    localStorage.setItem('csrfToken', token);
  }

  // API Fetch mit Refresh-Handling
  async function apiFetch(path, options = {}, useAuthHeaderToken = false) {
    const method = (options.method || 'GET').toUpperCase();
    const writeMethods = ['POST', 'PUT', 'DELETE', 'PATCH'];

    options = { ...options };
    options.headers = options.headers || {};
    options.credentials = 'include';

    if (writeMethods.includes(method)) {
      if (!options.headers['Content-Type']) options.headers['Content-Type'] = 'application/json';
      if (!csrfToken) {
        console.warn('‚ö†Ô∏è Kein CSRF-Token im localStorage gefunden.');
      } else {
        options.headers['X-CSRF-Token'] = csrfToken;
      }
    }

    if (useAuthHeaderToken) {
      const token = getCookie('token');
      if (token) options.headers['Authorization'] = 'Bearer ' + token;
    }

    const url = path.startsWith('http') ? path : ('/api' + path);

    async function fetchWithCookies() {
      return fetch(url, options);
    }

    let response = await fetchWithCookies();

    if (response.status === 401) {
      const refreshResponse = await fetch('/api/refresh', { method: 'POST', credentials: 'include' });
      if (!refreshResponse.ok) throw new Error('Token-Refresh fehlgeschlagen. Bitte neu einloggen.');
      response = await fetchWithCookies();
      if (response.status === 401) throw new Error('Token-Refresh fehlgeschlagen. Bitte neu einloggen.');
    }

    if (!response.ok) {
      let errorMsg = `Fehler: HTTP ${response.status}`;
      try {
        const errJson = await response.json();
        if (errJson.error) errorMsg = errJson.error;
        else if (errJson.message) errorMsg = errJson.message;
      } catch {
        const errText = await response.text().catch(() => '');
        if (errText) errorMsg = errText;
      }
      throw new Error(errorMsg);
    }

    try {
      return await response.json();
    } catch {
      return {};
    }
  }

  // Cookie auslesen
  function getCookie(name) {
    const cookies = document.cookie.split(';').map(c => c.trim());
    for (const cookie of cookies) {
      if (cookie.startsWith(name + '=')) {
        return decodeURIComponent(cookie.substring(name.length + 1));
      }
    }
    return null;
  }

  // QR-Code generieren
  async function generateQrCode() {
    if (!generateBtn || !qrContainer || !qrValidUntil) return;

    try {
      const res = await fetch('/api/qr/create', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': csrfToken,
          'Content-Type': 'application/json',
        },
        credentials: 'include',
      });

      if (!res.ok) {
        alert('Fehler beim QR-Code-Generieren');
        return;
      }

      const { qrToken, g√ºltigBis } = await res.json();
      const cleanToken = qrToken.trim();

      const canvas = document.createElement('canvas');
      await QRCode.toCanvas(canvas, cleanToken, {
        width: 256,
        margin: 1,
        color: { dark: '#000000', light: '#ffffff' },
        errorCorrectionLevel: 'M',
      });

      qrContainer.innerHTML = '';
      qrContainer.appendChild(canvas);

      const validUntil = new Date(g√ºltigBis).toLocaleTimeString();
      qrValidUntil.textContent = `G√ºltig bis: ${validUntil}`;
    } catch (err) {
      console.error('‚ùå Fehler beim Erzeugen des QR-Codes:', err);
      alert('Fehler beim Abrufen des QR-Codes.');
    }
  }

  // Login-Funktion
  async function login(email, passwort) {
    if (!email || !passwort) {
      alert('Bitte Email und Passwort ausf√ºllen!');
      return;
    }

    try {
      const res = await apiFetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, passwort }),
      });

      if (!res.user) {
        alert('Login erfolgreich, aber kein Benutzerobjekt erhalten.');
        return;
      }

      if (res.csrfToken) setCsrfToken(res.csrfToken);

      loggedInUser = res.user;

      await updateUIAfterLogin(res.user);
      showSection(timeTrackingSection);
    } catch (err) {
      alert('Login fehlgeschlagen: ' + err.message);
      console.error('‚ùå Login fehlgeschlagen:', err);
    }
  }

  // UI nach Login updaten
  async function updateUIAfterLogin(user) {
    if (!user) return;

    if (userNameSpan) {
      userNameSpan.textContent = user.name || user.email || 'Benutzer';
    }

    // QR Generator nur f√ºr Vorarbeiter anzeigen
    const qrGenSection = document.getElementById('qr-generator-section');
    if (qrGenSection) {
      if (user.rolle === 'vorarbeiter') qrGenSection.classList.remove('hidden');
      else qrGenSection.classList.add('hidden');
    }

    loggedInUser = user;

    showSection(timeTrackingSection);
    loginSection.classList.add('hidden');
    registerSection.classList.add('hidden');
    qrSection.classList.add('hidden');

    if (logoutBtn) logoutBtn.classList.remove('hidden');

    await updateTimeButtons();
  }

  // Zeitbuttons updaten
  async function updateTimeButtons() {
    try {
      const result = await apiFetch('/status');
      const eingestempelt = result.ist_eingestempelt;

      if (clockInBtn) clockInBtn.disabled = eingestempelt;
      if (clockOutBtn) clockOutBtn.disabled = !eingestempelt;
    } catch (err) {
      if (clockInBtn) clockInBtn.disabled = true;
      if (clockOutBtn) clockOutBtn.disabled = true;
      console.warn('Status konnte nicht geladen werden:', err);
    }
  }

  // Section anzeigen
  function showSection(section) {
    [qrSection, loginSection, registerSection, timeTrackingSection].forEach(s => {
      if (!s) return;
      s.classList.add('hidden');
      s.setAttribute('aria-hidden', 'true');
    });
    if (!section) return;
    section.classList.remove('hidden');
    section.setAttribute('aria-hidden', 'false');
  }

  // QR-Scanner Funktionen
  const config = { fps: 10, qrbox: 250 };

  async function startQrScanner() {
    if (scannerIsRunning) return;
    if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
    try {
      scannerIsRunning = true;
      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          await stopQrScanner();
          await onQrCodeDetected(decodedText);
        }
      );
    } catch (e) {
      scannerIsRunning = false;
      console.error("Fehler beim Starten des QR-Scanners:", e);
    }
  }

  async function stopQrScanner() {
    if (!scannerIsRunning) return;
    try {
      await html5QrCode.stop();
    } catch (e) {
      console.error("Fehler beim Stoppen des QR-Scanners:", e);
    }
    scannerIsRunning = false;
  }

  async function onQrCodeDetected(decodedText) {
    try {
      await validateQrCode(decodedText);
      showSection(loginSection);
      qrSection.classList.add('hidden');
    } catch (e) {
      alert("Ung√ºltiger QR-Code: " + e.message);
      await startQrScanner();
    }
  }

  async function validateQrCode(qr) {
    const token = localStorage.getItem('csrfToken');
    const res = await fetch('/api/validate-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': token },
      credentials: 'include',
      body: JSON.stringify({ qr }),
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'Ung√ºltiger QR-Code');
    }
    return await res.json();
  }

  // Initiale Pr√ºfung auf Vorarbeiter-Token oder QR-Scanner starten
  async function checkAccessAtStart() {
    try {
      const res = await fetch('/api/verify-vorarbeiter-token', { credentials: 'include' });
      if (res.ok) {
        qrSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
        return;
      }
    } catch {
      // Ignore
    }
    qrSection.classList.remove('hidden');
    loginSection.classList.add('hidden');
    await startQrScanner();
  }

  // Logout Funktion
  async function logout() {
    try {
      await apiFetch('/logout', { method: 'POST' });
      handleLogoutCleanup();
      alert('Logout erfolgreich!');
    } catch (err) {
      alert('Logout Fehler: ' + err.message);
    }
  }

  // Aufr√§umen nach Logout
  function handleLogoutCleanup() {
    loggedInUser = null;
    if (loginForm) {
      loginForm.email.value = '';
      loginForm.passwort.value = '';
    }
    sessionStorage.removeItem('accessToken');
    localStorage.removeItem('csrfToken');
    document.cookie = 'csrfToken=; Max-Age=0; path=/; secure; SameSite=None';

    showSection(qrSection);
    if (logoutBtn) logoutBtn.classList.add('hidden');
    if (userNameSpan) userNameSpan.textContent = '';

    const qrGenSection = document.getElementById('qr-generator-section');
    if (qrGenSection) qrGenSection.classList.add('hidden');
  }

  // --- Event Listener binden ---

  if (generateBtn) generateBtn.addEventListener('click', generateQrCode);

  if (settingsBtn && settingsDropdown && darkmodeSwitch) {
    settingsBtn.addEventListener('click', () => {
      settingsDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', e => {
      if (!settingsDropdown.contains(e.target) && e.target !== settingsBtn) {
        settingsDropdown.classList.add('hidden');
      }
    });

    // Dark Mode initial setzen
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

    darkmodeSwitch.addEventListener('change', () => {
      setTheme(darkmodeSwitch.checked ? 'dark' : 'light');
    });

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      darkmodeSwitch.checked = (theme === 'dark');
    }
  }

  document.querySelectorAll('#bottom-nav button').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      document.querySelectorAll('.view').forEach(s => s.classList.add('hidden'));
      const targetElem = document.getElementById(target);
      if (targetElem) {
        targetElem.classList.remove('hidden');
      }
    });
  });

  if (loginForm) {
    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const email = loginForm.email.value;
      const passwort = loginForm.passwort.value;
      await login(email, passwort);
    });
  }

  if (registerForm) {
    registerForm.addEventListener('submit', async e => {
      e.preventDefault();
      const name = registerForm.name.value;
      const email = registerForm.email.value;
      const passwort = registerForm.passwort.value;
      try {
        const res = await apiFetch('/register', {
          method: 'POST',
          body: JSON.stringify({ name, email, passwort }),
        });
        alert('Registrierung erfolgreich! Bitte anmelden.');
        showSection(loginSection);
      } catch (err) {
        alert('Registrierung fehlgeschlagen: ' + err.message);
      }
    });
  }

  if (showRegisterBtn) showRegisterBtn.addEventListener('click', () => showSection(registerSection));
  if (showLoginBtn) showLoginBtn.addEventListener('click', () => showSection(loginSection));
  if (logoutBtn) logoutBtn.addEventListener('click', logout);

  if (clockInBtn) {
    clockInBtn.addEventListener('click', async () => {
      try {
        await apiFetch('/zeit/start', { method: 'POST' });
        await updateTimeButtons();
        alert('Eingestempelt!');
      } catch (err) {
        alert('Fehler beim Einstempeln: ' + err.message);
      }
    });
  }

  if (clockOutBtn) {
    clockOutBtn.addEventListener('click', async () => {
      try {
        await apiFetch('/zeit/stop', { method: 'POST' });
        await updateTimeButtons();
        alert('Ausgestempelt!');
      } catch (err) {
        alert('Fehler beim Ausstempeln: ' + err.message);
      }
    });
  }

  // --- Initialisierung ---
  async function init() {
    try {
      // CSRF-Token vom Server holen, falls noch nicht gesetzt
      if (!csrfToken) {
        const res = await fetch('/api/csrf-token', { credentials: 'include' });
        if (res.ok) {
          const json = await res.json();
          if (json.csrfToken) setCsrfToken(json.csrfToken);
        }
      }

      // Pr√ºfen, ob schon eingeloggt (z.B. via Token im Cookie)
      const userResponse = await apiFetch('/me');
      if (userResponse.user) {
        await updateUIAfterLogin(userResponse.user);
      } else {
        await checkAccessAtStart();
      }
    } catch (err) {
      console.warn('Initialisierung fehlgeschlagen:', err);
      await checkAccessAtStart();
    }
  }

  init();
});
</script>

</body>
</html>
